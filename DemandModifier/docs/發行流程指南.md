# DemandModifier 發行新版本完整流程

## ⚠️ 重要提醒

**每次發行新版本前，必須完成以下兩項：**
1. ✅ 更新 `ModVersion` 版本號（使用語意化版本）
2. ✅ 填寫 `ChangeLog`（**絕對不可空白！**）

## 📝 發行前檢查清單

### 1. 更新 PublishConfiguration.xml

編輯 `Properties/PublishConfiguration.xml`：

```xml
<!-- 步驟 1: 更新版本號 -->
<ModVersion Value="0.0.14" />  <!-- 從 0.0.13 → 0.0.14 -->

<!-- 步驟 2: 填寫變更日誌（必填！） -->
<ChangeLog Value="修正電力系統錯誤、新增水資源控制功能" />

<!-- 或使用多行格式： -->
<ChangeLog>
- 新增無限電力功能
- 修正商業需求錯誤
- 更新繁體中文翻譯
</ChangeLog>
```

### 2. 確認遊戲版本相容性

```xml
<GameVersion Value="1.2.*" />  <!-- 確認支援的遊戲版本 -->
```

### 3. 檢查 ModId 是否正確

```xml
<ModId Value="123136" />  <!-- 你的 Mod ID，首次發佈後不應更改 -->
```

## 🚀 發行命令

### 方式一：使用 Visual Studio 發行設定檔（推薦）

1. **在 Visual Studio 中**：
   - 右鍵點擊專案 → **發行 (Publish)**
   - 選擇 `PublishNewVersion` 設定檔
   - 點擊 **發行**

### 方式二：使用 PowerShell 命令列

```powershell
# 確保在專案目錄下
cd E:\Code\CSL2\DemandModifier\DemandModifier\DemandModifier

# 方式 2A: 使用完整發行命令
dotnet publish -c Release /p:PublishProfile=PublishNewVersion

# 方式 2B: 使用 MSBuild（如果 dotnet publish 失敗）
msbuild /t:Publish /p:Configuration=Release /p:PublishProfile=PublishNewVersion
```

## ❌ 常見錯誤與解決方案

### 錯誤 1: 返回碼 -1
```
錯誤 MSB3073: ModPublisher.exe 命令以返回碼 -1 結束
```

**原因與解決方案：**

| 原因 | 檢查項目 | 解決方法 |
|------|----------|----------|
| ChangeLog 為空 | `<ChangeLog Value="" />` | **必須填寫變更內容** |
| ModVersion 未更新 | 版本號與線上相同 | 遞增版本號（如 0.0.13 → 0.0.14） |
| ModId 錯誤 | `<ModId Value="123136" />` | 確認 ModId 正確（首次發佈後獲得） |
| 網路問題 | 無法連接 PDX Mods | 檢查網路連線 |

### 錯誤 2: 找不到 ModPublisher.exe
```
無法找到 E:\SteamLibrary\...\ModPublisher.exe
```

**解決方案：**
1. 確認遊戲完整安裝
2. 檢查環境變數 `CSII_TOOLPATH` 是否設定正確：
   ```powershell
   $env:CSII_TOOLPATH
   # 應顯示你的 CS2 Modding SDK 路徑
   ```

### 錯誤 3: 編譯失敗
```
編譯失敗，無法產生 DLL
```

**解決方案：**
```powershell
# 先清理專案
dotnet clean

# 重新建置
dotnet build -c Release

# 檢查錯誤訊息
```

## 📦 完整發行流程（標準程序）

### 第一步：本機開發與測試

```powershell
# 1. 開發完成後，先本機測試
dotnet build -c Release

# 2. 複製到遊戲 Mods 目錄測試
$modsPath = "$env:LOCALAPPDATA\..\LocalLow\Colossal Order\Cities Skylines II\Mods\DemandModifier"
Copy-Item "bin\Release\net48\*" $modsPath -Recurse -Force

# 3. 啟動遊戲測試功能
```

### 第二步：更新版本資訊

```powershell
# 編輯 Properties/PublishConfiguration.xml
code Properties/PublishConfiguration.xml

# 必須更新：
# - ModVersion: 0.0.13 → 0.0.14
# - ChangeLog: 填寫變更內容
```

### 第三步：執行發行

```powershell
# 方式 1: 使用 dotnet publish
dotnet publish -c Release /p:PublishProfile=PublishNewVersion

# 方式 2: 使用 MSBuild（如果上面失敗）
msbuild /t:Publish /p:Configuration=Release /p:PublishProfile=PublishNewVersion
```

### 第四步：驗證發行

1. 檢查終端輸出是否有錯誤
2. 前往 [PDX Mods](https://mods.paradoxplaza.com/) 確認新版本已上線
3. 檢查版本號、ChangeLog 是否正確顯示

## 🔄 語意化版本號規則

使用 `X.Y.Z` 格式：

| 版本類型 | 範例 | 使用時機 |
|---------|------|----------|
| **主版本 (X)** | 1.0.0 → 2.0.0 | 重大變更、不相容更新 |
| **次版本 (Y)** | 0.1.0 → 0.2.0 | 新增功能、向下相容 |
| **修訂版 (Z)** | 0.0.1 → 0.0.2 | 錯誤修正、小調整 |

**目前版本：** 0.0.13 → 建議下次更新為 **0.0.14** 或 **0.1.0**（如有新功能）

## 📋 發行檢查清單範本

複製此範本，每次發行前逐項檢查：

```
發行前檢查 - 版本 X.Y.Z
==========================

□ 程式碼功能已完成並測試
□ 本機遊戲測試通過
□ 所有語系檔案已更新（7 種語言）
□ PublishConfiguration.xml 已更新：
  □ ModVersion 已遞增
  □ ChangeLog 已填寫（不為空）
  □ GameVersion 相容性已確認
  □ LongDescription 已更新（如需要）
□ 專案已清理並重新建置（dotnet clean + build）
□ 無編譯錯誤和警告

執行發行：
□ dotnet publish -c Release /p:PublishProfile=PublishNewVersion
□ 發行成功（無錯誤訊息）
□ PDX Mods 頁面已更新
□ 版本號正確顯示
□ ChangeLog 正確顯示
```

## 🛠️ 進階：自動化發行腳本

建立 `Properties/PublishHelper.ps1`：

```powershell
# 發行輔助腳本
param(
    [string]$NewVersion,
    [string]$ChangeLog
)

if (-not $NewVersion -or -not $ChangeLog) {
    Write-Host "使用方式: .\PublishHelper.ps1 -NewVersion '0.0.14' -ChangeLog '修正錯誤'" -ForegroundColor Yellow
    exit 1
}

Write-Host "準備發行新版本: $NewVersion" -ForegroundColor Cyan

# 1. 更新 PublishConfiguration.xml
$configPath = "PublishConfiguration.xml"
$xml = [xml](Get-Content $configPath)
$xml.Publish.ModVersion.Value = $NewVersion
$xml.Publish.ChangeLog.Value = $ChangeLog
$xml.Save($configPath)
Write-Host "✓ 已更新版本號和 ChangeLog" -ForegroundColor Green

# 2. 清理並重新建置
Write-Host "執行清理..." -ForegroundColor Cyan
dotnet clean | Out-Null
dotnet build -c Release
if ($LASTEXITCODE -ne 0) {
    Write-Host "✗ 建置失敗！" -ForegroundColor Red
    exit 1
}
Write-Host "✓ 建置成功" -ForegroundColor Green

# 3. 執行發行
Write-Host "開始發行..." -ForegroundColor Cyan
dotnet publish -c Release /p:PublishProfile=PublishNewVersion
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ 發行成功！" -ForegroundColor Green
    Write-Host "請前往 PDX Mods 確認：https://mods.paradoxplaza.com/" -ForegroundColor Yellow
} else {
    Write-Host "✗ 發行失敗！" -ForegroundColor Red
    exit 1
}
```

**使用範例：**
```powershell
cd Properties
.\PublishHelper.ps1 -NewVersion "0.0.14" -ChangeLog "修正電力系統錯誤、新增水資源控制"
```

## 📚 參考資源

- [Paradox Wiki - Modding Toolchain](https://cs2.paradoxwikis.com/Modding_Toolchain#C#_Mod_Project_Template)
- [PDX Mods 官方網站](https://mods.paradoxplaza.com/)
- [專案開發指南](../copilot-instructions.md)

---

**最後提醒：** 每次發行前，請確保 `ChangeLog` 不為空白，這是最常見的錯誤原因！
