# 發佈失敗問題解決報告

**日期**：2025年10月28日  
**問題**：使用 `PublishNewVersion.pubxml` 發佈時失敗  
**狀態**：✅ 已解決

## 問題描述

執行 `dotnet publish /p:PublishProfile=PublishNewVersion` 時出現以下錯誤：

```
error MSB3231: 無法移除目錄 "C:\Users\zheng\AppData\LocalLow\Colossal Order\Cities Skylines II\Mods\DemandModifier"。
Access to the path 'DemandModifier_win_x86_64.dll' is denied.
```

## 根本原因

**ModPublisher.exe 的發佈流程**：
1. 刪除舊版模組目錄 `Mods\DemandModifier\`
2. 複製新版本檔案
3. 上傳到 PDX Mods 平台

**問題**：當 Cities: Skylines 2 遊戲正在執行時，模組的 DLL 檔案會被遊戲載入並鎖定，導致 ModPublisher 無法刪除舊檔案。

## 解決方案

### 方法 1：關閉遊戲後發佈（推薦）

```powershell
# 1. 關閉 Cities: Skylines 2
# 2. 執行發佈命令
dotnet publish /p:PublishProfile=PublishNewVersion

# 或使用快速腳本
.\scripts\quick-publish.ps1
```

### 方法 2：使用自動化腳本

更新 `quick-publish.ps1` 加入遊戲進程檢查：

```powershell
# 檢查遊戲是否正在執行
$gameProcess = Get-Process -Name "Cities2" -ErrorAction SilentlyContinue
if ($gameProcess) {
    Write-Host "❌ 偵測到遊戲正在執行中！" -ForegroundColor Red
    Write-Host "請先關閉 Cities: Skylines 2 再執行發佈。" -ForegroundColor Yellow
    exit 1
}

# 繼續發佈流程
dotnet publish /p:PublishProfile=PublishNewVersion
```

## 正確的發佈流程

### 完整步驟

1. **更新版本資訊**（`Properties\PublishConfiguration.xml`）
   ```xml
   <ModVersion Value="0.0.7" />
   <ChangeLog Value="修正內容..." />
   ```

2. **確認變更已提交**
   ```powershell
   git add .
   git commit -m "v0.0.7: 更新內容"
   ```

3. **關閉遊戲**
   - 完全退出 Cities: Skylines 2
   - 確認工作管理員中無 `Cities2.exe` 進程

4. **執行發佈**
   ```powershell
   # 方法 A：使用快速腳本
   .\scripts\quick-publish.ps1

   # 方法 B：使用 dotnet 命令
   dotnet publish /p:PublishProfile=PublishNewVersion
   ```

5. **驗證發佈**
   - 登入 [PDX Mods](https://mods.paradoxplaza.com/)
   - 檢查模組頁面是否更新

6. **標記 Git 版本**
   ```powershell
   git tag v0.0.7
   git push origin master --tags
   ```

## 預防措施

### 開發階段檢查清單

- [ ] 更新 `<ModVersion>` 版本號
- [ ] 撰寫 `<ChangeLog>` 更新日誌
- [ ] 本機測試所有功能
- [ ] 提交所有變更到 Git
- [ ] **關閉遊戲**（重要！）
- [ ] 執行發佈命令
- [ ] 驗證 PDX Mods 平台
- [ ] 標記 Git 版本

### 建議的自動化改進

建立 `scripts\safe-publish.ps1`：

```powershell
param([switch]$Force)

# 檢查遊戲進程
$gameProcess = Get-Process -Name "Cities2" -ErrorAction SilentlyContinue
if ($gameProcess -and -not $Force) {
    Write-Host "⚠️  偵測到遊戲正在執行中！" -ForegroundColor Yellow
    $response = Read-Host "是否強制終止遊戲並繼續？(y/N)"
    if ($response -eq 'y') {
        Stop-Process -Name "Cities2" -Force
        Start-Sleep -Seconds 2
    } else {
        Write-Host "❌ 已取消發佈" -ForegroundColor Red
        exit 1
    }
}

# 檢查未提交的變更
$gitStatus = git status --porcelain
if ($gitStatus) {
    Write-Host "⚠️  偵測到未提交的變更：" -ForegroundColor Yellow
    git status -s
    $response = Read-Host "是否繼續發佈？(y/N)"
    if ($response -ne 'y') {
        exit 1
    }
}

# 執行發佈
Write-Host "🚀 開始發佈..." -ForegroundColor Green
dotnet publish /p:PublishProfile=PublishNewVersion

if ($LASTEXITCODE -eq 0) {
    Write-Host "✅ 發佈成功！" -ForegroundColor Green
} else {
    Write-Host "❌ 發佈失敗！" -ForegroundColor Red
    exit $LASTEXITCODE
}
```

## 技術細節

### ModPublisher 工具行為

```
ModPublisher.exe NewVersion <PublishConfiguration.xml> -c <ModsPath> -v
```

**執行流程**：
1. 讀取 `PublishConfiguration.xml`
2. 驗證 `<ModId>` 存在（NewVersion 模式必須）
3. **刪除** `<ModsPath>\DemandModifier\` 目錄
4. 建置並複製新版本到該目錄
5. 打包並上傳到 PDX Mods
6. 更新線上 Metadata

**關鍵限制**：步驟 3 需要完全的檔案存取權，任何被鎖定的檔案都會導致失敗。

### Windows 檔案鎖定機制

- .NET Assembly (DLL) 被載入到進程後會被鎖定
- 即使模組被遊戲「停用」，DLL 仍在記憶體中
- 必須完全結束遊戲進程才會釋放鎖定

## 相關檔案

- `Properties\PublishProfiles\PublishNewVersion.pubxml` - 發佈設定檔
- `Properties\PublishConfiguration.xml` - 模組 Metadata
- `scripts\quick-publish.ps1` - 快速發佈腳本

## 參考連結

- [Cities: Skylines 2 Modding Documentation](https://cs2.paradoxwikis.com/Modding)
- [PDX Mods Platform](https://mods.paradoxplaza.com/)
