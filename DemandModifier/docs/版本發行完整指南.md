# 🚀 DemandModifier 版本更新與發行完整指南

## 📌 目錄
1. [發行前準備檢查清單](#發行前準備檢查清單)
2. [版本號更新](#版本號更新)
3. [發行新版本到 Paradox Mods](#發行新版本到-paradox-mods)
4. [常見錯誤與解決方案](#常見錯誤與解決方案)

---

## 發行前準備檢查清單

### ✅ 必須完成的項目

#### 1. 確認程式碼變更
```powershell
# 查看所有變更
git status

# 確認程式碼已提交
git add .
git commit -m "Version 0.0.14 - 你的更新內容"
```

#### 2. 測試模組功能
- [ ] 建置 Release 版本成功
- [ ] 在遊戲中測試所有功能
- [ ] 檢查設定 UI 是否正常顯示
- [ ] 測試切換不同語言
- [ ] 確認無錯誤日誌

#### 3. 準備縮圖 (Thumbnail)
- **檔案路徑**：`Properties/Thumbnail.png`
- **尺寸要求**：256x256 像素
- **格式**：PNG

如果沒有縮圖，建立一個預設圖片：
```powershell
# 檢查是否存在
Test-Path "e:\Code\CSL2\DemandModifier\DemandModifier\DemandModifier\Properties\Thumbnail.png"
```

**⚠️ 重要**：如果沒有縮圖，必須建立一個或暫時移除該設定行。

---

## 版本號更新

### 📝 語意化版本規則

使用 **語意化版本 (Semantic Versioning)**：`主版本.次版本.修訂號`

- **主版本 (Major)**：重大變更，可能不相容舊版本
  - 範例：`0.x.x` → `1.0.0`
- **次版本 (Minor)**：新增功能，向下相容
  - 範例：`0.0.x` → `0.1.0`
- **修訂號 (Patch)**：Bug 修復，小幅改進
  - 範例：`0.0.13` → `0.0.14`

### 🔧 更新步驟

#### 步驟 1：更新 `PublishConfiguration.xml`

開啟 `Properties/PublishConfiguration.xml`，修改以下欄位：

```xml
<!-- 更新版本號 -->
<ModVersion Value="0.0.14" />

<!-- 更新遊戲版本相容性 (如需要) -->
<GameVersion Value="1.2.*" />

<!-- 更新變更日誌 (必填！) -->
<ChangeLog Value="Version 0.0.14 - 新增無限金錢功能，修復商業需求 Bug" />
```

**📋 變更日誌範例格式：**
```xml
<!-- 簡短版本 -->
<ChangeLog Value="Version 0.0.14 - 新增無限金錢功能，修復商業需求 Bug" />

<!-- 多行詳細版本 -->
<ChangeLog>
**Version 0.0.14**
- 新增：無限金錢功能
- 新增：免費建設選項
- 修復：商業需求不正常的 Bug
- 改進：設定介面多國語系翻譯
</ChangeLog>
```

#### 步驟 2：更新 `CHANGELOG.md`

在 `docs/CHANGELOG.md` 記錄詳細變更：

```markdown
## [0.0.14] - 2025-10-27

### 新增
- 無限金錢功能
- 免費建設選項

### 修復
- 修正商業需求不正常的問題

### 改進
- 優化設定介面翻譯
```

---

## 發行新版本到 Paradox Mods

### 🎯 使用 PublishNewVersion 發行更新

#### 步驟 1：確認 ModId 已設定

檢查 `PublishConfiguration.xml` 的 `<ModId>` 欄位：
```xml
<ModId Value="123136" />
```
✅ 你的 ModId 是 `123136`，已正確設定。

#### 步驟 2：執行 Release 建置

```powershell
# 清理舊建置產物
dotnet clean

# 建置 Release 版本
dotnet build -c Release

# 確認建置成功
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ 建置成功" -ForegroundColor Green
} else {
    Write-Host "✗ 建置失敗，請檢查錯誤訊息" -ForegroundColor Red
    exit
}
```

#### 步驟 3：檢查必要檔案

```powershell
# 檢查 DLL 是否存在
Test-Path "bin\Release\net48\DemandModifier.dll"

# 檢查語系檔案
Get-ChildItem "bin\Release\net48\l10n\*.json"

# 檢查縮圖 (如果設定檔中有指定)
Test-Path "Properties\Thumbnail.png"
```

#### 步驟 4：發行新版本

```powershell
# 發行新版本到 Paradox Mods
dotnet publish /p:PublishProfile=PublishNewVersion
```

**⏳ 發行過程說明：**
1. ModPublisher 會壓縮你的 DLL 和語系檔案
2. 上傳到 Paradox Mods 伺服器
3. 更新模組資訊 (版本號、變更日誌、描述等)
4. 驗證檔案完整性

**✅ 成功訊息：**
```
Mod published successfully!
Mod ID: 123136
Version: 0.0.14
```

**❌ 如果失敗，請查看 [常見錯誤](#常見錯誤與解決方案)**

---

## 常見錯誤與解決方案

### ❌ 錯誤 1：返回碼 -1 (你目前遇到的問題)

**錯誤訊息：**
```
錯誤 MSB3073: ModPublisher.exe" 命令以返回碼 -1 結束。
```

**可能原因與解決方案：**

#### 原因 A：ChangeLog 為空
```xml
<!-- ❌ 錯誤 -->
<ChangeLog Value="" />

<!-- ✅ 正確 -->
<ChangeLog Value="Version 0.0.14 - 新增無限金錢功能" />
```

#### 原因 B：Thumbnail 檔案不存在
```powershell
# 檢查縮圖是否存在
Test-Path "Properties\Thumbnail.png"

# 如果不存在，有兩個選擇：

# 選擇 1：移除縮圖設定 (暫時)
# 在 PublishConfiguration.xml 中註解掉
<!--<Thumbnail Value="Properties/Thumbnail.png" />-->

# 選擇 2：建立一個預設縮圖 (建議)
# 使用任何圖片編輯工具建立 256x256 的 PNG 圖片
```

#### 原因 C：網路連線問題
```powershell
# 測試連線到 Paradox Mods API
Test-NetConnection -ComputerName mods.paradoxplaza.com -Port 443
```

#### 原因 D：ModId 錯誤
確認 ModId 是否正確：
- 首次發行：使用 `PublishNewMod` (不需要 ModId)
- 更新版本：使用 `PublishNewVersion` (需要正確的 ModId)

---

### ❌ 錯誤 2：找不到 ModPublisher.exe

**錯誤訊息：**
```
找不到路徑 'ModPublisher.exe'
```

**解決方案：**
1. 確認環境變數設定正確：
```powershell
$env:CSII_TOOLPATH
# 應該顯示你的 SDK 路徑
```

2. 檢查 ModPublisher.exe 是否存在：
```powershell
$publisherPath = "E:\SteamLibrary\steamapps\common\Cities Skylines II\Cities2_Data\Content\Game\.ModdingToolchain\ModPublisher\ModPublisher.exe"
Test-Path $publisherPath
```

3. 如果不存在，重新安裝 Cities: Skylines 2 Modding SDK

---

### ❌ 錯誤 3：版本號格式錯誤

**錯誤訊息：**
```
Invalid ModVersion format
```

**解決方案：**
```xml
<!-- ❌ 錯誤格式 -->
<ModVersion Value="v0.0.14" />
<ModVersion Value="0.14" />
<ModVersion Value="14" />

<!-- ✅ 正確格式 -->
<ModVersion Value="0.0.14" />
<ModVersion Value="1.0.0" />
<ModVersion Value="0.1.2" />
```

---

### ❌ 錯誤 4：GameVersion 不相容

**錯誤訊息：**
```
Incompatible game version
```

**解決方案：**
```xml
<!-- 支援 1.2.x 所有版本 -->
<GameVersion Value="1.2.*" />

<!-- 支援 1.x.x 所有版本 -->
<GameVersion Value="1.*" />

<!-- 指定精確版本 -->
<GameVersion Value="1.2.3" />
```

---

## 📚 完整發行工作流程

### 🔄 標準發行流程 (建議)

```powershell
# 1. 確認所有變更已提交
git status
git add .
git commit -m "Version 0.0.14 release"

# 2. 更新版本號和變更日誌
# 手動編輯 Properties/PublishConfiguration.xml

# 3. 清理並建置
dotnet clean
dotnet build -c Release

# 4. 本機測試 (可選但強烈建議)
$modsPath = "$env:LOCALAPPDATA\..\LocalLow\Colossal Order\Cities Skylines II\Mods\DemandModifier"
Copy-Item "bin\Release\net48\*" $modsPath -Recurse -Force
# 啟動遊戲測試

# 5. 發行到 Paradox Mods
dotnet publish /p:PublishProfile=PublishNewVersion

# 6. 推送到 GitHub
git tag v0.0.14
git push origin master
git push origin v0.0.14

# 7. 在 GitHub 建立 Release (可選)
# 前往 https://github.com/ChengBoChuan/demandmodifier/releases/new
```

---

## 🎨 建立 Thumbnail 縮圖

### 使用線上工具

1. **Canva** (https://www.canva.com/)
   - 選擇「自訂尺寸」→ 256x256 像素
   - 設計你的模組圖示
   - 下載為 PNG

2. **Photopea** (https://www.photopea.com/)
   - 免費的線上 Photoshop 替代品
   - 建立 256x256 的新專案
   - 設計並匯出為 PNG

3. **簡易方案**：使用 PowerShell 生成純色縮圖
```powershell
# 這需要安裝 System.Drawing (僅作展示，建議使用專業工具)
Add-Type -AssemblyName System.Drawing
$bmp = New-Object System.Drawing.Bitmap 256, 256
$graphics = [System.Drawing.Graphics]::FromImage($bmp)
$graphics.Clear([System.Drawing.Color]::DodgerBlue)
$bmp.Save("Properties\Thumbnail.png")
$graphics.Dispose()
$bmp.Dispose()
```

---

## 📊 版本發行檢查表

複製此檢查表到每次發行時使用：

```markdown
## Version 0.0.14 發行檢查表

### 發行前
- [ ] 所有程式碼變更已提交
- [ ] 功能測試通過
- [ ] 多國語系檔案已更新
- [ ] PublishConfiguration.xml 版本號已更新
- [ ] ChangeLog 已填寫
- [ ] CHANGELOG.md 已更新
- [ ] Thumbnail.png 存在且正確

### 建置
- [ ] `dotnet clean` 成功
- [ ] `dotnet build -c Release` 成功
- [ ] `bin\Release\net48\DemandModifier.dll` 存在
- [ ] `bin\Release\net48\l10n\*.json` 存在

### 發行
- [ ] `dotnet publish /p:PublishProfile=PublishNewVersion` 成功
- [ ] Paradox Mods 頁面已更新
- [ ] 版本號顯示正確

### 發行後
- [ ] Git tag 已建立
- [ ] GitHub Release 已發布 (可選)
- [ ] 通知社群更新 (可選)
```

---

## 🔗 相關資源

- **Paradox Wiki - Modding Toolchain**: https://cs2.paradoxwikis.com/Modding_Toolchain
- **你的模組頁面**: https://mods.paradoxplaza.com/mods/123136/Windows
- **GitHub Repository**: https://github.com/ChengBoChuan/demandmodifier

---

## 💡 提示與最佳實踐

### 版本號管理
- 初期開發：`0.0.x` (小幅改進和修復)
- 功能穩定：`0.1.0` (第一個穩定版本)
- 重大更新：`1.0.0` (正式版本)

### 變更日誌撰寫
- 使用清楚的分類：新增、修復、改進、移除
- 每個項目簡潔明瞭
- 提及重要的 Bug 修復
- 如有破壞性變更，務必註明

### 發行頻率
- Bug 修復：盡快發行 (修訂號 +1)
- 新功能：累積到一定數量再發行 (次版本 +1)
- 重大重構：充分測試後發行 (主版本 +1)

---

**最後更新**：2025-10-27
**作者**：DemandModifier 開發團隊
